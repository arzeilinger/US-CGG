---
title: "Data visualizataions of GAM data Generated by Housen bootstrapping 500 times"
output: html_notebook
---


```{r echo = FALSE}
rm(list=ls())

require(dplyr)
require(mgcv)
library(mgcv)
library(ggplot2)
library(ISLR)
library(mgcv)
library(boot)
require(matrixStats)
library(zoo)
```


```{r}
na.count<-function(x) sum(is.na(x))
na.mean<-function(x) ifelse(is.nan(mean(x,na.rm=T)),NA,mean(x,na.rm=T))
```


#Defining the data I/O directory

```{r}
## change root.path as needed
root.path<-"C:\\Users\\tfens\\R_REPOS\\Flux_processing\\Concord_R_Code\\Concord_Post_Process\\"
# root.path<-"D:\\Housen\\Flux\\Data-exploring\\02_Concord_Eden\\"
#output folder
out.path<-paste0(root.path, "02_output\\01_GAM_output\\")

```



#load the RDA data produced in 12-Concord_bootstrap_GAMS_all
#Housen uploaded the data as rda files to google drive. 
```{r}

all_data <-  readRDS (file = "2022-04-20_all_data.rda" )

all_daily_data <- readRDS (file = "2022-04-20_all_data_daily.rda" )



all_filled_cum_matrix <- readRDS(file = "2022-04-20_all_filled_matrix.rda")

all_filled_matrix <- readRDS(file = "2022-04-20_all_filled_matrix.rda")

all_filled_matrix <- readRDS(file = "2022-04-20_all_predict_matrix.rda")

```


```{r}

all_data$all_pre_data
write.csv(
  all_data$all_pre_data,
  paste0(out.path, Sys.Date(), "_all_pre_compost_data.csv"),
  quote = T,
  row.names = F
)
```



#Figure for cumulative filled NEE by pre and post compost and group

```{r}

col.code2 <- list(col.name = c("control", "treatment"),
                 col = c("firebrick1", "deepskyblue"))

##### Figure for filled NEE
png(
    paste0(
      out.path,
      Sys.Date(),
      "_filled_cum_NEE_bygroups.png"
    ),
    width = 6.5,
    height = 3.5,
    units = "in",
    pointsize = 10,
    res = 400
  )
par(mar = c(4, 0.2, 0.5, 0.2), oma = c(0, 4, 0, 0.5), mfrow = c(1, 2))
plot(all_data[[1]]$TIMESTAMP,
     all_data[[1]]$NEE_filled_cum_control_mean,
     pch = 20,
     cex = 0.7,
     col = col.code2$col[1],
     las = 1,
     ylab = "",
     xlab = "",
     ylim = c(-100, 200))
mtext(side = 2,
      expression(Cumulative~CO[2]~flux~'('*g~C~m^{-2}*')'),
      outer = T,
      line = 2.5)
mtext(side = 1,
      "2019-2020",
      outer = F,
      line = 2.5)
points(all_data[[1]]$TIMESTAMP,
       all_data[[1]]$NEE_filled_cum_treatment_mean,
       pch = 20,
       cex = 0.7,
       col = col.code2$col[2])
lines(all_data[[1]]$TIMESTAMP,
      all_data[[1]]$NEE_filled_cum_control_q025,
      col = col.code2$col[1],
      lty = 2)
lines(all_data[[1]]$TIMESTAMP,
      all_data[[1]]$NEE_filled_cum_control_q975,
      col = col.code2$col[1],
      lty = 2)
lines(all_data[[1]]$TIMESTAMP,
      all_data[[1]]$NEE_filled_cum_treatment_q025,
      col = col.code2$col[2],
      lty = 2)
lines(all_data[[1]]$TIMESTAMP,
      all_data[[1]]$NEE_filled_cum_treatment_q975,
      col = col.code2$col[2],
      lty = 2)
legend("topleft",
       fill = col.code2$col,
       border = NA,
       legend = col.code2$col.name,
       ncol = 2,
       cex = 0.7,
       bty = "n")
abline(h = 0, col = "black")
plot(all_data[[2]]$TIMESTAMP,
     all_data[[2]]$NEE_filled_cum_control_mean,
     pch = 20,
     cex = 0.7,
     col = col.code2$col[1],
     las = 1,
     ylab = "",
     xlab = "",
     yaxt = "n",
     ylim = c(-100, 200))
mtext(side = 1,
      "2020-2021",
      outer = F,
      line = 2.5)
points(all_data[[2]]$TIMESTAMP,
       all_data[[2]]$NEE_filled_cum_treatment_mean,
       pch = 20,
       cex = 0.7,
       col = col.code2$col[2])
lines(all_data[[2]]$TIMESTAMP,
      all_data[[2]]$NEE_filled_cum_control_q025,
      col = col.code2$col[1],
      lty = 2)
lines(all_data[[2]]$TIMESTAMP,
      all_data[[2]]$NEE_filled_cum_control_q975,
      col = col.code2$col[1],
      lty = 2)
lines(all_data[[2]]$TIMESTAMP,
      all_data[[2]]$NEE_filled_cum_treatment_q025,
      col = col.code2$col[2],
      lty = 2)
lines(all_data[[2]]$TIMESTAMP,
      all_data[[2]]$NEE_filled_cum_treatment_q975,
      col = col.code2$col[2],
      lty = 2)
abline(h = 0, col = "black")
dev.off()
```
#figure for gap filled daily NEE. Updated to include the error range for the post compost control side daily data
```{r}
col.code4 <- list(col.name = c("control", "treatment"),
                  col = c("firebrick4", "deepskyblue4"),
                  col2 = c(rgb(1, 0, 0, 0.3), rgb(0, 0, 1, 0.3)),
                  col3 = c("lightcoral", "deepskyblue4"))

##### Figure for gap-filled daily NEE
png(
    paste0(
      out.path,
      Sys.Date(),
      "_filled_daily_NEE_bygroups.png"
    ),
    width = 6.5,
    height = 3.5,
    units = "in",
    pointsize = 10,
    res = 400
  )
par(mar = c(4, 0.2, 0.5, 0.2), oma = c(0, 4, 0, 0.5), mfrow = c(1, 2))
plot(0,
     0,
     las = 1,
     ylab = "",
     xlab = "",
     ylim = c(-10, 10),
     xlim = range(all_daily_data[[1]]$Doy_water),
     type = "n")
mtext(side = 1,
      "2019-2020",
      outer = F,
      line = 2.5)
mtext(side = 2,
      expression(CO[2]~flux~'('*g~C~m^{-2}~d^{-1}*')'),
      outer = T,
      line = 2.5)
polygon(c(all_daily_data[[1]]$Doy_water,
          rev(all_daily_data[[1]]$Doy_water)),
        c(all_daily_data[[1]]$NEE_filled_control_q975,
          rev(all_daily_data[[1]]$NEE_filled_control_q025)),
        col = col.code4$col3[1],
        border = NA)
polygon(c(all_daily_data[[1]]$Doy_water,
          rev(all_daily_data[[1]]$Doy_water)),
        c(all_daily_data[[1]]$NEE_filled_treatment_q975,
          rev(all_daily_data[[1]]$NEE_filled_treatment_q025)),
        col = col.code4$col2[2],
        border = NA)
points(all_daily_data[[1]]$Doy_water,
       all_daily_data[[1]]$NEE_filled_control_mean,
       pch = 20,
       cex = 0.7,
       col = col.code4$col[1])
points(all_daily_data[[1]]$Doy_water,
       all_daily_data[[1]]$NEE_filled_treatment_mean,
       pch = 20,
       cex = 0.7,
       col = col.code4$col[2])
legend("topleft",
       fill = col.code4$col,
       border = NA,
       legend = col.code2$col.name,
       ncol = 2,
       cex = 0.7,
       bty = "n")
plot(0,
     0,
     las = 1,
     ylab = "",
     xlab = "",
     yaxt = "n",
     ylim = c(-10, 10),
     xlim = range(all_daily_data[[2]]$Doy_water),
     type = "n")
mtext(side = 1,
      "2020-2021",
      outer = F,
      line = 2.5)
polygon(c(all_daily_data[[2]]$Doy_water,
          rev(all_daily_data[[2]]$Doy_water)),
        c(all_daily_data[[2]]$NEE_filled_control_q975,
          rev(all_daily_data[[2]]$NEE_filled_control_q025)),
        col = col.code4$col3[1],
        border = NA)
polygon(c(all_daily_data[[2]]$Doy_water,
          rev(all_daily_data[[2]]$Doy_water)),
        c(all_daily_data[[2]]$NEE_filled_treatment_q975,
          rev(all_daily_data[[2]]$NEE_filled_treatment_q025)),
        col = col.code4$col2[2],
        border = NA)
points(all_daily_data[[2]]$Doy_water,
       all_daily_data[[2]]$NEE_filled_control_mean,
       pch = 20,
       cex = 0.7,
       col = col.code4$col[1])
points(all_daily_data[[2]]$Doy_water,
       all_daily_data[[2]]$NEE_filled_treatment_mean,
       pch = 20,
       cex = 0.7,
       col = col.code4$col[2])
dev.off()

## save output
saveRDS(all_daily_data,
        paste0(out.path, Sys.Date(), "_all_daily_data.rda"))
```



#Tommy just getting a sense of the lists and data

```{r}
#Reco_mean and quantiles
plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$RECO_predict_control_mean, ylim = c(0,35) )

par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$RECO_predict_control_q975, col = 'red', ylim = c(0,35))

par(new = TRUE)
plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$RECO_predict_control_q025, col = 'blue', ylim = c(0,35))

#NEE
#1/2 hourly
plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_control_mean)

#cumulative with error
plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_cum_control_q975, col='red', ylim = c(0,200)
     )

par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_cum_control_mean, col='grey', ylim = c(0,200))

par(new = TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_cum_control_q025 , col='red', ylim = c(0,200)
     )

```
#Creating a new data column for respiration 
#combination of Day Reco_predict_mean annd NEE_filled__means
#Our night time respiration data will be directly measured, while our daytime respiration data will be modeled. 

#This is actually unnneccesary. Just going to use NEE- Reco predict and then force all nightime GPP to zero. 

```{r}


####Control side pre-compost#########################
# creating new column called RECO_control_FIN
all_data$all_pre_data$RECO_control_FIN <- (all_data$all_pre_data$RECO_predict_control_mean * 1)




#assigning all night time respiration gap fill night NEE

all_data$all_pre_data$RECO_control_FIN[(all_data$all_pre_data$Rg <= 10 )]<-
  all_data$all_pre_data$NEE_filled_control_mean [(all_data$all_pre_data$Rg <= 10 )]

#plot and summary of recon control fin (observed nighttime NEE, and modeled Reco)
plot(all_data$all_pre_data$RECO_control_FIN )

summary(all_data$all_pre_data$RECO_control_FIN)

#plot and summary of just modeled Reco
plot(all_data$all_pre_data$RECO_predict_control_mean)
summary(all_data$all_pre_data$RECO_predict_control_mean)



#Thought I had to do all this below, but really do not need to. Can just use the filled NEE (see above). Filled NEE has actual NEE values for night time plus GAM filled. This ensures both actually measured values, excluding bad data and the best modeled nigh time NEE/ Reco

#Creating observed NEE variable to be used for nighttime reco

# all_data[[1]]$NEE_control_observed[all_data[[1]]$treatment== "control_pre_compost"] <- (all_data[[1]]$NEE[all_data[[1]]$treatment == "control_pre_compost"])
#
# plot(all_data$all_pre_data$NEE_control_observed) # around 1/2 night observed reco data is neg. maybe just use modeled data?
#
# #looking at how the new variable look
# summary(all_data$all_pre_data$NEE_control_observed)
# summary(all_data$all_pre_data$RECO_control_FIN)
#
# #assigning night time measured NEE values to the associated night time respiration values
#
# all_data$all_pre_data$RECO_control_FIN[all_data$all_pre_data$Rg <= 10 & !is.na( all_data$all_pre_data$NEE_control_observed)]<-
#   all_data$all_pre_data$NEE_control_observed[all_data$all_pre_data$Rg<=10  & !is.na( all_data$all_pre_data$NEE_control_observed)]
#
#
# #seeing how this shakes out
# plot(all_data$all_pre_data$RECO_control_FIN )
#
# summary(all_data$all_pre_data$RECO_control_FIN)
#
# summary(all_data$all_pre_data$RECO_predict_control_mean)
#
# summary(all_data$all_pre_data$NEE_filled_control_mean)
#
# plot(all_data$all_pre_data$TIMESTAMP, all_data$all_pre_data$RECO_control_FIN, col = 'red', ylim = c(-10, 30))
# par(new= TRUE)
# plot(all_data$all_pre_data$TIMESTAMP, all_data$all_pre_data$RECO_predict_control_mean, col = 'blue', ylim = c(-10, 30))

##############Control side post-compost######################
#creating new column called RECO_control_FIN
all_data$all_post_data$RECO_control_FIN <- (all_data$all_post_data$RECO_predict_control_mean * 1)

#assigning all night time respiration gap fill night NEE

all_data$all_post_data$RECO_control_FIN[(all_data$all_post_data$Rg <= 10 )]<-
  all_data$all_post_data$NEE_filled_control_mean [(all_data$all_post_data$Rg <= 10 )]

plot(all_data$all_post_data$RECO_control_FIN )

summary(all_data$all_post_data$RECO_control_FIN)

summary(all_data$all_post_data$NEE_filled_control_mean)


###############treatment side pre compost############################
all_data$all_pre_data$RECO_treatment_FIN <- (all_data$all_pre_data$RECO_predict_treatment_mean * 1)



###########treatment side post-compost###############
#creating new column called RECO_treatment_FIN
all_data$all_post_data$RECO_treatment_FIN <- (all_data$all_post_data$RECO_predict_treatment_mean * 1)


#assigning all night time respiration gap fill night NEE pre compost

all_data$all_pre_data$RECO_treatment_FIN[(all_data$all_pre_data$Rg <= 10 )]<-
  all_data$all_pre_data$NEE_filled_treatment_mean [(all_data$all_pre_data$Rg <= 10 )]

plot(all_data$all_pre_data$RECO_treatment_FIN )

summary(all_data$all_pre_data$RECO_treatment_FIN)

summary(all_data$all_pre_data$NEE_filled_treatment_mean)



#assigning all night time respiration gap fill night NEE post compost

all_data$all_post_data$RECO_treatment_FIN[(all_data$all_post_data$Rg <= 10 )]<-
  all_data$all_post_data$NEE_filled_treatment_mean [(all_data$all_post_data$Rg <= 10 )]

plot(all_data$all_post_data$RECO_treatment_FIN, ylim = c(0,5), col = "blue" )
par(new= TRUE)
plot(all_data$all_post_data$RECO_predict_treatment_mean, ylim = c(0,5), col = "red")

summary(all_data$all_post_data$RECO_treatment_FIN)
summary(all_data$all_post_data$RECO_predict_treatment_mean)

summary(all_data$all_post_data$NEE_filled_treatment_mean)

```


#creating 1/2 hour GPP control and treatment side values 
#sum(nee) = sum(gpp+reco)
#sum (nee-reco)= sum (gpp)
 
```{r}

######Creating 1/2 hourly GPP variable for post compost##########

#control post compost(Reco predict_control mean or Reco_control_fin)
#Use Reco_predict control mean and force all nighttime GPP to zero. 
all_data$all_post_data$GPP_control_mean <- (all_data$all_post_data$NEE_filled_control_mean - all_data$all_post_data$RECO_predict_control_mean)

summary(all_data$all_post_data$GPP_control_mean)

plot(all_data$all_post_data$GPP_control_mean)

#treatment post compost
all_data$all_post_data$GPP_treatment_mean<- (all_data$all_post_data$NEE_filled_treatment_mean - all_data$all_post_data$RECO_predict_treatment_mean  )

summary(all_data$all_post_data$GPP_treatment_mean)


plot(all_data$all_post_data$GPP_treatment_mean)

#######Make all night time GPP zero############ #Need to do this if using reco_predict!

#night time defined as Rg<= 10

#control post compost
all_data$all_post_data$GPP_control_mean [(all_data$all_post_data$Rg <= 10 )]<-0

plot(all_data$all_post_data$GPP_control_mean)

summary(all_data$all_post_data$GPP_control_mean)

#treatment  post compost
all_data$all_post_data$GPP_treatment_mean [(all_data$all_post_data$Rg <= 10 )]<-0

##########95% CI for GPP#####################

#making 95% confidence intervals for GPP control post compost
all_data$all_post_data$GPP_control_q025 <- (all_data$all_post_data$NEE_predict_control_q025 - all_data$all_post_data$RECO_predict_control_q025)


all_data$all_post_data$GPP_control_q975 <- (all_data$all_post_data$NEE_predict_control_q975 - all_data$all_post_data$RECO_predict_control_q975)

#making 95% confidence intervals for GPP treatment post compost
all_data$all_post_data$GPP_treatment_q025 <- (all_data$all_post_data$NEE_predict_treatment_q025 - all_data$all_post_data$RECO_predict_treatment_q025)


all_data$all_post_data$GPP_treatment_q975 <- (all_data$all_post_data$NEE_predict_treatment_q975 - all_data$all_post_data$RECO_predict_treatment_q975)

##########plotting 1/2hourly Reco and GPP############

#control post compost
plot(all_data$all_post_data$TIMESTAMP[(all_data$all_post_data$Rg > 10 )], all_data$all_post_data$GPP_control_mean[(all_data$all_post_data$Rg > 10 )], col='green', ylim = c(-12,6))


par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$RECO_predict_control_mean , col='red', ylim = c(-12,6)
     )
par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_control_mean , ylim = c(-12,6))


plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$GPP_control_mean, ylim = c(-12,6))

#treatment post compost
plot(all_data$all_post_data$TIMESTAMP[(all_data$all_post_data$Rg > 10 )], all_data$all_post_data$GPP_treatment_mean[(all_data$all_post_data$Rg > 10 )], col='green', ylim = c(-12,6))


par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$RECO_predict_treatment_mean , col='red', ylim = c(-12,6)
     )
par(new=TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_treatment_mean , ylim = c(-12,6))


plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$GPP_treatment_mean, ylim = c(-12,6))

```

#GPP pre compost variable

```{r}
######Creating 1/2 hourly GPP variable##########

#control pre compost
all_data$all_pre_data$GPP_control_mean <- (all_data$all_pre_data$NEE_filled_control_mean - all_data$all_pre_data$RECO_predict_control_mean)

summary(all_data$all_pre_data$GPP_control_mean)

#treatment pre compost
all_data$all_pre_data$GPP_treatment_mean<- (all_data$all_pre_data$NEE_filled_treatment_mean - all_data$all_pre_data$RECO_predict_treatment_mean  )

summary(all_data$all_pre_data$GPP_treatment_mean)

#######Make all night time GPP zero############ Need to do this since using Reco_predict_mean
#night time defined as Rg<= 10

# #control pre compost
all_data$all_pre_data$GPP_control_mean [(all_data$all_pre_data$Rg <= 10 )]<-0
 
# #treatment  pre compost
all_data$all_pre_data$GPP_treatment_mean [(all_data$all_pre_data$Rg <= 10 )]<-0

##########95% CI for GPP#####################

#making 95% confidence intervals for GPP control pre compost
all_data$all_pre_data$GPP_control_q025 <- (all_data$all_pre_data$NEE_predict_control_q025 - all_data$all_pre_data$RECO_predict_control_q025)


all_data$all_pre_data$GPP_control_q975 <- (all_data$all_pre_data$NEE_predict_control_q975 - all_data$all_pre_data$RECO_predict_control_q975)

#making 95% confidence intervals for GPP treatment pre compost
all_data$all_pre_data$GPP_treatment_q025 <- (all_data$all_pre_data$NEE_predict_treatment_q025 - all_data$all_pre_data$RECO_predict_treatment_q025)


all_data$all_pre_data$GPP_treatment_q975 <- (all_data$all_pre_data$NEE_predict_treatment_q975 - all_data$all_pre_data$RECO_predict_treatment_q975)
```






#Basic plots of control side post compost to make sure I'm on right track before making final figures
```{r}
#############Cumulative GPP, RECO , NEE control side post compost growing season#####



#cumulative respiration control side
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_control_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Control Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=1,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_control_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Control Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=2,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_control_q025  ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Control Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=2,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
#cumulative GPP control side

plot(cumsum(tapply(all_data$all_post_data$GPP_control_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=1,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

plot(cumsum(tapply(all_data$all_post_data$GPP_control_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=2,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

plot(cumsum(tapply(all_data$all_post_data$GPP_control_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=2,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_cum_control_mean, 
      xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=1,
     col="grey",
     lwd=2,
     type="l")
     
axis(side=1,at=seq(0,360,by=30))

par(new =TRUE)
abline(h = 0, col = "black")

```

```{r}

#############Cumulative GPP, RECO , NEE treatmett side post compost growing season#####
#cumulative respiration treatment side
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Treatment Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=1,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_q975,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Treatment Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=2,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
plot(cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,

     xaxt='n',
     xlab='Days of the growing season',
     ylab=expression(Cumulative~Reco~GPP~NEE~'('~g~C~m^{-2}~')'),
     main='Post Compost Treatment Side Cumulative RECO, GPP, NEE',
     cex.lab = 0.8,
     ylim = c(-800,800),
     lty=2,
     col="red",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)
#cumulative GPP treatment side

plot(cumsum(tapply(all_data$all_post_data$GPP_treatment_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=1,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

plot(cumsum(tapply(all_data$all_post_data$GPP_treatment_q025 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=2,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

plot(cumsum(tapply(all_data$all_post_data$GPP_treatment_q975,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48,
     xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=2,
     col="green",
     lwd=2,
     type="l")
axis(side=1,at=seq(0,360,by=30))

par(new = TRUE)

#cumulative NEE treatment side

plot(all_data$all_post_data$TIMESTAMP, all_data$all_post_data$NEE_filled_cum_treatment_mean, 
      xaxt='n',
     xlab='',
     ylab='',
     main='',
     ylim = c(-800,800),
     lty=1,
     col="grey",
     lwd=2,
     type="l")
     
axis(side=1,at=seq(0,360,by=30))

par(new =TRUE)
abline(h = 0, col = "black")
```



```{r}
#blank
all_data$all_post_data$blank = (all_data$all_post_data$RECO_control_FIN *
                                      0)

all_data$all_post_data$blank[(all_data$all_post_data$blank == 0)] <-
  NA
```


#Plotting NEE variables###

####panel 1 half-hourly non-gap filled and half hourly gap filled###
#panel 1/2 hourly GPP_treatment_mean and Respiration
#panel 3 cumulative sums of NEE, Respiration and neg GPP


#Treatment side 1/2 hourly
```{r}
summary (all_data$all_pre_data$NEE)

summary(all_data$all_post_data$NEE)

head(all_data$all_pre_data$TIMESTAMP)

nrow(all_data$all_pre_data$NEE_predict_control_mean
        )
```



```{r}



col.code3 <- list(col.name = c("control (modeled)", "treatment (modeled)",
                               "control (observed)", "treatment (observed)"),
                  col = c("firebrick1", "deepskyblue", "firebrick4", "deepskyblue4"))

#figure for cumulative and filled NEE and Reco

target.plot.var_nee <- c("NEE_filled_treatment_mean",
                         "GPP_treatment_mean",
                         "blank")

target.plot.var_nee.title <- c(
  expression(FC ~ '(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(GPP ~ ';' ~ Reco~'(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(Cumulative~sum~ '(' ~ g ~ C ~ m ^ {-2 } ~ ')')
)

## locate the start of each month
month.loc <- which(
  all_data$all_post_data$TIMESTAMP$mday == 1 &
    all_data$all_post_data$TIMESTAMP$hour == 0 &
    all_data$all_post_data$TIMESTAMP$min == 0
)
month.ticks <-
  substr(seq(
    all_data$all_post_data$TIMESTAMP[month.loc[1]],
    all_data$all_post_data$TIMESTAMP[month.loc[length(month.loc)]],
    by = "months"
  ), 6, 7)

## daily average values
daily_nee.tmp <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )


## convert NEE, RECO_predict_treatment_mean gpp to cumulative sum of carbon
# convert to cumulative carbon
for(ll in 2:4) {
  # convert to daily units
  daily_nee.tmp[, ll] <-
    daily_nee.tmp[, ll] * 12 / 1000000 * 1800 * 48
  daily_nee.tmp[is.na(daily_nee.tmp[, ll]), ll] <- 0
  
  # calculate cumulative sum, hard-coded with first/second years
  daily_nee.tmp[1:365, ll] <-
    cumsum(daily_nee.tmp[1:365, ll])
  daily_nee.tmp[366:nrow(daily_nee.tmp), ll] <-
    cumsum(daily_nee.tmp[366:nrow(daily_nee.tmp), ll])
  
  # set break (missing value) between two years
  daily_nee.tmp[366, ll] <- NA
}

## begin plot   
png(
  paste0(out.path, "NEE_treatment_growing_post_compost_concord",
    all_data$all_post_data$TIMESTAMP$year[1] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[1] + 1, "_",
    all_data$all_post_data$TIMESTAMP$year[nrow(all_data$all_post_data)] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[nrow(all_data$all_post_data)] + 1, "_",
    "NEE_",
    Sys.Date(), ".png"
  ),
  width = 5.5,
  height = 6,
  units = "in",
  res = 300,
  pointsize = 11,
  bg = "white"
)
par(oma = c(4, 4.5, 0.5, 0.5),
    mar = c(0, 0, 0.25, 0))

par(fig = c(0, 1, 2 / 3, 1), new = FALSE)
plot(
  all_data[[2]]$TIMESTAMP,
  all_data[[2]]$NEE_filled_treatment_mean,
  pch = 20,
  cex = 0.7,
  col = col.code3$col[1],
  las = 1,
  ylab = "",
  xlab = "",
  xaxt = "n",
  xaxs = "i",
  #yaxt = "n",
  ylim = c(-20, 20),
  cex.axis = 0.8
)

points(
  all_data[[2]]$TIMESTAMP[all_data[[2]]$treatment == "treatment_post_compost"],
  all_data[[2]]$NEE[all_data[[2]]$treatment == "treatment_post_compost"],
  pch = 20,
  cex = 0.7,
  col = col.code3$col[4]
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(a)"),
  adj = c(0, 1),
  cex = 0.9,
  
)

mtext(
  side = 2,
  target.plot.var_nee.title[[1]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

## panel b
par(fig = c(0, 1, 1 / 3, 2 / 3), new = TRUE)
plot(
  all_data$all_post_data$time.id,
  all_data$all_post_data$GPP_treatment_mean,
  xlab = "",
  ylab = "",
  cex = 0.5,
  col = "forestgreen",
  bg = "forestgreen",
  xaxt = "n",
  las = 1,
  pch = 21,
  xaxs = "i",
  ylim = c(-10, 10),
  cex.axis = 0.8
)

points(
  all_data$all_post_data$time.id,
  all_data$all_post_data$RECO_predict_treatment_mean,
  cex = 0.5,
  col = "red",
  bg = "red",
  pch = 21,
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(b)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee.title[[2]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)


## panel c
par(fig = c(0, 1, 0, 1 / 3), new = TRUE)
plot(
  daily_nee.tmp$date,
  daily_nee.tmp$daily_nee,
  type = "l",
  lwd = 1.5,
  col = "black",
  xlab = "",
  ylab = "",
  xaxt = "n",
  las = 1,
  xaxs = "i",
  ylim = c(-375, 375),
  cex.axis = 0.8
)

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_gpp,
      lwd = 1.5,
      col = "forestgreen",
      lty = 2
      )

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_reco,
      lwd = 1.5,
      col = "red",
      lty = 3
      )

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

axis(
  side = 1,
  at = all_data$all_post_data$time.id[month.loc],
  labels = month.ticks,
  tck = -.025,
  cex.axis = 0.8
)

text(
  x = all_data$all_post_data$time.id[1],
  y = 1200,
  paste0("(c)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee.title[[3]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

axis(
  side = 1,
  at = c(2019.75, 2020.5, 2021.17),
  label = c(2019, 2020, 2021),
  cex.axis = 0.8,
  tck = -.025,
  lty = 0,
  bty = "n",
  line = 0.9
)

mtext(
  side = 1,
  "Month / Year",
  line = 3,
  outer = FALSE,
  cex = 0.8
)


dev.off()
```



####panel 1 half-hourly non-gap filled and half hourly gap filled###
#panel 2 daily GPP_treatment_mean and Respiration with error lines shaded
#panel 3 cumulative sums of NEE, Respiration and neg GPP with error lines


#Treatment side Daily



```{r}



col.code4 <- list(col.name = c( "treatment (modeled)","treatment (observed)"),
                               
                  col = c("deepskyblue", "deepskyblue4"))

col.code5 <- list(col.name = c("Reco", "GPP"),
                
                  col3 = c("lightcoral", "lightgreen"))




#figure for cumulative and filled NEE and Reco

target.plot.var_nee <- c("NEE_filled_treatment_mean",
                         "GPP_treatment_mean",
                         "blank")

target.plot.var_nee.title <- c(
  expression(FC ~ '(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(GPP ~ ';' ~ Reco~'(' ~ mu ~ mol ~ m ^ {-2 } ~ d ^ { -1 } ~ ')'),
  expression(Cumulative~sum~ '(' ~ g ~ C ~ m ^ {-2 } ~ ')')
)

## locate the start of each month
month.loc <- which(
  all_data$all_post_data$TIMESTAMP$mday == 1 &
    all_data$all_post_data$TIMESTAMP$hour == 0 &
    all_data$all_post_data$TIMESTAMP$min == 0
)
month.ticks <-
  substr(seq(
    all_data$all_post_data$TIMESTAMP[month.loc[1]],
    all_data$all_post_data$TIMESTAMP[month.loc[length(month.loc)]],
    by = "months"
  ), 6, 7)

## daily average values
daily_nee.tmp <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

#Creating a second daily value data frame that is not cum_sum for panel B
daily_nee.tmp_2 <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

## convert NEE, RECO_predict_treatment_mean gpp to cumulative sum of carbon
# convert to cumulative carbon
for(ll in 2:8) {
  # convert to daily units
  daily_nee.tmp[, ll] <-
    daily_nee.tmp[, ll] * 12 / 1000000 * 1800 * 48
  daily_nee.tmp[is.na(daily_nee.tmp[, ll]), ll] <- 0
  
  # calculate cumulative sum, hard-coded with first/second years
  daily_nee.tmp[1:365, ll] <-
    cumsum(daily_nee.tmp[1:365, ll])
  daily_nee.tmp[366:nrow(daily_nee.tmp), ll] <-
    cumsum(daily_nee.tmp[366:nrow(daily_nee.tmp), ll])
  
  # set break (missing value) between two years
  daily_nee.tmp[366, ll] <- NA
}

## begin plot   
png(
  paste0(out.path, "NEE_treatment_Daily_growing_post_compost_concord",
    all_data$all_post_data$TIMESTAMP$year[1] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[1] + 1, "_",
    all_data$all_post_data$TIMESTAMP$year[nrow(all_data$all_post_data)] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[nrow(all_data$all_post_data)] + 1, "_",
    "NEE_",
    Sys.Date(), ".png"
  ),
  width = 5.5,
  height = 6,
  units = "in",
  res = 300,
  pointsize = 11,
  bg = "white"
)
par(oma = c(4, 4.5, 0.5, 0.5),
    mar = c(0, 0, 0.25, 0))

par(fig = c(0, 1, 2 / 3, 1), new = FALSE)
plot(
  all_data[[2]]$TIMESTAMP,
  all_data[[2]]$NEE_filled_treatment_mean,
  pch = 20,
  cex = 0.7,
  col = col.code4$col[1],
  las = 1,
  ylab = "",
  xlab = "",
  xaxt = "n",
  xaxs = "i",
  #yaxt = "n",
  ylim = c(-15, 15),
  cex.axis = 0.8
)

points(
  all_data[[2]]$TIMESTAMP[all_data[[2]]$treatment == "treatment_post_compost"],
  all_data[[2]]$NEE[all_data[[2]]$treatment == "treatment_post_compost"],
  pch = 20,
  cex = 0.7,
  col = col.code4$col[2]
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(a)"),
  adj = c(0, 1),
  cex = 0.9,
  
)

mtext(
  side = 2,
  target.plot.var_nee.title[[1]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)
legend(
  "topleft",
  fill = col.code4$col,
  border = NA,
  legend = col.code4$col.name,
  ncol = 2,
  cex = 0.7,
  bty = "n"
)

## panel b
par(fig = c(0, 1, 1 / 3, 2 / 3), new = TRUE)
plot(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_gpp,
  xlab = "",
  ylab = "",
  cex = 0,
  col = "forestgreen",
  bg = "forestgreen",
  xaxt = "n",
  las = 1,
  pch = 21,
  xaxs = "i",
  ylim = c(-10, 10),
  cex.axis = 0.8
)
polygon(c(daily_nee.tmp_2$date,
          rev(daily_nee.tmp_2$date)),
        c(daily_nee.tmp_2$daily_reco975 ,
          rev(daily_nee.tmp_2$daily_reco025)),
        col = col.code5$col3[1],
        border = NA)
polygon(c(daily_nee.tmp_2$date,
          rev(daily_nee.tmp_2$date)),
        c(daily_nee.tmp_2$daily_gppq975 ,
          rev(daily_nee.tmp_2$daily_gpp_q025)),
        col = col.code5$col3[2],
        border = NA)
points(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_reco,
  cex = 0.6,
  col = "red",
  bg = "red",
  pch = 21,
)

points(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_gpp,
  cex = 0.6,
  col = "forestgreen",
  bg = "forestgreen",
  pch = 21,
)


abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(b)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee.title[[2]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)


## panel c
par(fig = c(0, 1, 0, 1 / 3), new = TRUE)
plot(
  daily_nee.tmp$date,
  daily_nee.tmp$daily_nee,
  type = "l",
  lwd = 1.5,
  col = "black",
  xlab = "",
  ylab = "",
  xaxt = "n",
  las = 1,
  xaxs = "i",
  ylim = c(-600, 800),
  cex.axis = 0.8
)

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_gpp,
      lwd = 1.5,
      col = "forestgreen",
      lty = 1
      )

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_reco,
      lwd = 1.5,
      col = "red",
      lty = 1
      )

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_gpp_q025 ,
      lwd = 1,
      col = "forestgreen",
      lty = 3
      )

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_gppq975  ,
      lwd = 1,
      col = "forestgreen",
      lty = 3
      )

lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_reco025,
      lwd = 1,
      col = "red",
      lty = 3
      )
lines(daily_nee.tmp$date,
      daily_nee.tmp$daily_reco975,
      lwd = 1,
      col = "red",
      lty = 3
      )

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

axis(
  side = 1,
  at = all_data$all_post_data$time.id[month.loc],
  labels = month.ticks,
  tck = -.025,
  cex.axis = 0.8
)

text(
  x = all_data$all_post_data$time.id[1],
  y = 1200,
  paste0("(c)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee.title[[3]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

axis(
  side = 1,
  at = c(2019.75, 2020.92, 2021.17),
  label = c(2019, 2020, 2021),
  cex.axis = 0.8,
  tck = -.025,
  lty = 0,
  bty = "n",
  line = 0.9
)

mtext(
  side = 1,
  "Month / Year",
  line = 3,
  outer = FALSE,
  cex = 0.8
)


dev.off()

```
#Appendix figure showing observed and modeled  treatment side post compost application

####panel 1 half-hourly non-gap filled and half hourly gap filled###
#panel 2 daily GPP_treatment_mean and Respiration with error lines shaded



```{r}
col.code4 <- list(col.name = c( "treatment (modeled)","treatment (observed)"),
                               
                  col = c("deepskyblue", "deepskyblue4"))

col.code5 <- list(col.name = c("Reco", "GPP"),
                
                  col3 = c("lightcoral", "lightgreen"))




#figure for cumulative and filled NEE and Reco

target.plot.var_nee <- c("NEE_filled_treatment_mean",
                         "GPP_treatment_mean",
                         "blank")

target.plot.var_nee.title <- c(
  expression(FC ~ '(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(GPP ~ ';' ~ Reco~'(' ~ mu ~ mol ~ m ^ {-2 } ~ d ^ { -1 } ~ ')'),
  expression(Cumulative~sum~ '(' ~ g ~ C ~ m ^ {-2 } ~ ')')
)

## locate the start of each month
month.loc <- which(
  all_data$all_post_data$TIMESTAMP$mday == 1 &
    all_data$all_post_data$TIMESTAMP$hour == 0 &
    all_data$all_post_data$TIMESTAMP$min == 0
)
month.ticks <-
  substr(seq(
    all_data$all_post_data$TIMESTAMP[month.loc[1]],
    all_data$all_post_data$TIMESTAMP[month.loc[length(month.loc)]],
    by = "months"
  ), 6, 7)

## daily average values
daily_nee.tmp <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

#Creating a second daily value data frame that is not cum_sum for panel B
daily_nee.tmp_2 <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_treatment_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_treatment_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

## convert NEE, RECO_predict_treatment_mean gpp to cumulative sum of carbon
# convert to cumulative carbon
for(ll in 2:8) {
  # convert to daily units
  daily_nee.tmp[, ll] <-
    daily_nee.tmp[, ll] * 12 / 1000000 * 1800 * 48
  daily_nee.tmp[is.na(daily_nee.tmp[, ll]), ll] <- 0
  
  # calculate cumulative sum, hard-coded with first/second years
  daily_nee.tmp[1:365, ll] <-
    cumsum(daily_nee.tmp[1:365, ll])
  daily_nee.tmp[366:nrow(daily_nee.tmp), ll] <-
    cumsum(daily_nee.tmp[366:nrow(daily_nee.tmp), ll])
  
  # set break (missing value) between two years
  daily_nee.tmp[366, ll] <- NA
}

## begin plot   
png(
  paste0(out.path, "NEE_treatment_appendix_model_observed_daily",
    all_data$all_post_data$TIMESTAMP$year[1] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[1] + 1, "_",
    all_data$all_post_data$TIMESTAMP$year[nrow(all_data$all_post_data)] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[nrow(all_data$all_post_data)] + 1, "_",
    "NEE_",
    Sys.Date(), ".png"
  ),
  width = 5.5,
  height = 6,
  units = "in",
  res = 300,
  pointsize = 11,
  bg = "white"
)
par(oma = c(4, 4.5, 0.5, 0.5),
    mar = c(0, 0, 0.25, 0))

par(fig = c(0, 1, 1 /2, 1), new = FALSE)
plot(
  all_data[[2]]$TIMESTAMP,
  all_data[[2]]$NEE_filled_treatment_mean,
  pch = 20,
  cex = 0.7,
  col = col.code4$col[1],
  las = 1,
  ylab = "",
  xlab = "",
  xaxt = "n",
  xaxs = "i",
  #yaxt = "n",
  ylim = c(-15, 15),
  cex.axis = 0.8
)

points(
  all_data[[2]]$TIMESTAMP[all_data[[2]]$treatment == "treatment_post_compost"],
  all_data[[2]]$NEE[all_data[[2]]$treatment == "treatment_post_compost"],
  pch = 20,
  cex = 0.7,
  col = col.code4$col[2]
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(a)"),
  adj = c(0, 1),
  cex = 0.9,
  
)



#adding panel label
mtext(
  "A", side=2, line=3, at=14, las = 1
  )

mtext(
  side = 2,
  target.plot.var_nee.title[[1]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

legend(
  "topleft",
  fill = col.code4$col,
  border = NA,
  legend = col.code4$col.name,
  ncol = 2,
  cex = 0.7,
  bty = "n"
)

## panel b
par(fig = c(0, 1, 0, 1 / 2), new = TRUE)
plot(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_gpp,
  xlab = "",
  ylab = "",
  cex = 0,
  col = "forestgreen",
  bg = "forestgreen",
  xaxt = "n",
  las = 1,
  pch = 21,
  xaxs = "i",
  ylim = c(-10, 10),
  cex.axis = 0.8
)
polygon(c(daily_nee.tmp_2$date,
          rev(daily_nee.tmp_2$date)),
        c(daily_nee.tmp_2$daily_reco975 ,
          rev(daily_nee.tmp_2$daily_reco025)),
        col = col.code5$col3[1],
        border = NA)
polygon(c(daily_nee.tmp_2$date,
          rev(daily_nee.tmp_2$date)),
        c(daily_nee.tmp_2$daily_gppq975 ,
          rev(daily_nee.tmp_2$daily_gpp_q025)),
        col = col.code5$col3[2],
        border = NA)
points(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_reco,
  cex = 0.6,
  col = "red",
  bg = "red",
  pch = 21,
)

points(
  daily_nee.tmp_2$date,
  daily_nee.tmp_2$daily_gpp,
  cex = 0.6,
  col = "forestgreen",
  bg = "forestgreen",
  pch = 21,
)


abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(b)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee.title[[2]],
  line = 3,
  outer = FALSE,
  cex = 0.8
  
  
)

axis(
  side = 1,
  at = all_data$all_post_data$time.id[month.loc],
  labels = month.ticks,
  tck = -.025,
  cex.axis = 0.8
)

text(
  x = all_data$all_post_data$time.id[1],
  y = 1200,
  paste0("(c)"),
  adj = c(0, 1),
  cex = 0.9
)


axis(
  side = 1,
  at = c(2019.75, 2020.92, 2021.17),
  label = c(2019, 2020, 2021),
  cex.axis = 0.8,
  tck = -.025,
  lty = 0,
  bty = "n",
  line = 0.9
)

mtext(
  side = 1,
  "Month / Year",
  line = 3,
  outer = FALSE,
  cex = 0.8
)
mtext(
  "B", side=2, line=3, at=9, las = 1
  )



dev.off()
```


####panel 1 Control half-hourly non-gap filled and half hourly gap filled###
#panel 2 1/2 hourly GPP_control_mean and Respiration with error lines shaded
#panel 3 cumulative sums of Control NEE, Respiration and GPP


#Control side side with 1/2 hourly data in panel 2



```{r}


#figure for cumulative and filled NEE and Reco

target.plot.var_nee_cont <- c("NEE_filled_control_mean",
                         "GPP_control_mean",
                         "blank")

target.plot.var_nee_cont.title <- c(
  expression(FC ~ '(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(GPP ~ ';' ~ Reco~'(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(Cumulative~sum~ '(' ~ g ~ C ~ m ^ {-2 } ~ ')')
)

## locate the start of each month
month.loc <- which(
  all_data$all_post_data$TIMESTAMP$mday == 1 &
    all_data$all_post_data$TIMESTAMP$hour == 0 &
    all_data$all_post_data$TIMESTAMP$min == 0
)
month.ticks <-
  substr(seq(
    all_data$all_post_data$TIMESTAMP[month.loc[1]],
    all_data$all_post_data$TIMESTAMP[month.loc[length(month.loc)]],
    by = "months"
  ), 6, 7)

## daily average values
daily_nee.tmp_cont <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

## convert NEE, RECO_predict_treatment_mean gpp to cumulative sum of carbon
# convert to cumulative carbon
for(ll in 2:4) {
  # convert to daily units
  daily_nee.tmp_cont[, ll] <-
    daily_nee.tmp_cont[, ll] * 12 / 1000000 * 1800 * 48
  daily_nee.tmp_cont[is.na(daily_nee.tmp_cont[, ll]), ll] <- 0
  
  # calculate cumulative sum, hard-coded with first/second years
  daily_nee.tmp_cont[1:365, ll] <-
    cumsum(daily_nee.tmp_cont[1:365, ll])
  daily_nee.tmp_cont[366:nrow(daily_nee.tmp_cont), ll] <-
    cumsum(daily_nee.tmp_cont[366:nrow(daily_nee.tmp_cont), ll])
  
  # set break (missing value) between two years
  daily_nee.tmp_cont[366, ll] <- NA
}

## begin plot   
png(
  paste0(out.path, "NEE_CONTROL_growing_post_compost_concord",
    all_data$all_post_data$TIMESTAMP$year[1] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[1] + 1, "_",
    all_data$all_post_data$TIMESTAMP$year[nrow(all_data$all_post_data)] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[nrow(all_data$all_post_data)] + 1, "_",
    "NEE_",
    Sys.Date(), ".png"
  ),
  width = 5.5,
  height = 6,
  units = "in",
  res = 300,
  pointsize = 11,
  bg = "white"
)
par(oma = c(4, 4.5, 0.5, 0.5),
    mar = c(0, 0, 0.25, 0))

par(fig = c(0, 1, 2 / 3, 1), new = FALSE)
plot(
  all_data[[2]]$TIMESTAMP,
  all_data[[2]]$NEE_filled_control_mean,
  pch = 20,
  cex = 0.7,
  col = col.code4$col[1],
  las = 1,
  ylab = "",
  xlab = "",
  xaxt = "n",
  xaxs = "i",
  #yaxt = "n",
  ylim = c(-20, 20),
  cex.axis = 0.8
)

points(
  all_data[[2]]$TIMESTAMP[all_data[[2]]$treatment == "control_post_compost"],
  all_data[[2]]$NEE[all_data[[2]]$treatment == "control_post_compost"],
  pch = 20,
  cex = 0.7,
  col = col.code4$col[4]
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_cont$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(a)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee_cont.title[[1]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

## panel b
par(fig = c(0, 1, 1 / 3, 2 / 3), new = TRUE)
plot(
  all_data$all_post_data$time.id,
  all_data$all_post_data$GPP_control_mean,
  xlab = "",
  ylab = "",
  cex = 0.5,
  col = "forestgreen",
  bg = "forestgreen",
  xaxt = "n",
  las = 1,
  pch = 21,
  xaxs = "i",
  ylim = c(-10, 10),
  cex.axis = 0.8
)

points(
  all_data$all_post_data$time.id,
  all_data$all_post_data$RECO_predict_control_mean,
  cex = 0.5,
  col = "red",
  bg = "red",
  pch = 21,
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_cont$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(b)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee_cont.title[[2]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)


## panel c
par(fig = c(0, 1, 0, 1 / 3), new = TRUE)
plot(
  daily_nee.tmp_cont$date,
  daily_nee.tmp_cont$daily_nee,
  type = "l",
  lwd = 1.5,
  col = "black",
  xlab = "",
  ylab = "",
  xaxt = "n",
  las = 1,
  xaxs = "i",
  ylim = c(-375, 375),
  cex.axis = 0.8
)

lines(daily_nee.tmp_cont$date,
      daily_nee.tmp_cont$daily_gpp,
      lwd = 1.5,
      col = "forestgreen",
      lty = 2
      )

lines(daily_nee.tmp_cont$date,
      daily_nee.tmp_cont$daily_reco,
      lwd = 1.5,
      col = "red",
      lty = 3
      )

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_cont$date[366], lwd= 1.5, col = "black")

axis(
  side = 1,
  at = all_data$all_post_data$time.id[month.loc],
  labels = month.ticks,
  tck = -.025,
  cex.axis = 0.8
)

text(
  x = all_data$all_post_data$time.id[1],
  y = 1200,
  paste0("(c)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee_cont.title[[3]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

axis(
  side = 1,
  at = c(2019.75, 2020.5, 2021.17),
  label = c(2019, 2020, 2021),
  cex.axis = 0.8,
  tck = -.025,
  lty = 0,
  bty = "n",
  line = 0.9
)

mtext(
  side = 1,
  "Month / Year",
  line = 3,
  outer = FALSE,
  cex = 0.8
)


dev.off()
```


####panel 1 Control half-hourly non-gap filled and half hourly gap filled###
#panel 2 daily GPP_control_mean and Respiration with error lines shaded
#panel 3 cumulative sums of Control NEE, Respiration and neg GPP with error lines

#control side daily data in panel 2
```{r}
 col.code6 <- list(col.name = c( "control (modeled)","control (observed)"),
                               
                  col = c("firebrick1", "firebrick4"))





#figure for cumulative and filled NEE and Reco

target.plot.var_nee_control_daily <- c("NEE_filled_control_mean",
                         "GPP_control_mean",
                         "blank")

target.plot.var_nee_control_daily.title <- c(
  expression(FC ~ '(' ~ mu ~ mol ~ m ^ {-2 } ~ s ^ { -1 } ~ ')'),
  expression(GPP ~ ';' ~ Reco~'(' ~ mu ~ mol ~ m ^ {-2 } ~ d ^ { -1 } ~ ')'),
  expression(Cumulative~sum~ '(' ~ g ~ C ~ m ^ {-2 } ~ ')')
)

## locate the start of each month
month.loc <- which(
  all_data$all_post_data$TIMESTAMP$mday == 1 &
    all_data$all_post_data$TIMESTAMP$hour == 0 &
    all_data$all_post_data$TIMESTAMP$min == 0
)
month.ticks <-
  substr(seq(
    all_data$all_post_data$TIMESTAMP[month.loc[1]],
    all_data$all_post_data$TIMESTAMP[month.loc[length(month.loc)]],
    by = "months"
  ), 6, 7)

## daily average values
daily_nee.tmp_controlside <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_control_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_control_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_control_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_control_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

#Creating a second daily value data frame that is not cum_sum for panel B
daily_nee.tmp_controlside_2 <-
  data.frame(
    date = tapply(
      all_data$all_post_data$time.id,
      all_data$all_post_data$Doy_water,
      min
    ),
    daily_nee = tapply(
      all_data$all_post_data$NEE_filled_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp = tapply(
      all_data$all_post_data$GPP_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco = tapply(
      all_data$all_post_data$RECO_predict_control_mean,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gpp_q025 = tapply(
      all_data$all_post_data$GPP_control_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_gppq975 = tapply(
      all_data$all_post_data$GPP_control_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco025 = tapply(
      all_data$all_post_data$RECO_predict_control_q025,
      all_data$all_post_data$Doy_water,
      na.mean
    ),
    daily_reco975 = tapply(
      all_data$all_post_data$RECO_predict_control_q975,
      all_data$all_post_data$Doy_water,
      na.mean
    )
  )

## convert NEE, RECO_predict_control_mean gpp to cumulative sum of carbon
# convert to cumulative carbon
for(ll in 2:8) {
  # convert to daily units
  daily_nee.tmp_controlside[, ll] <-
    daily_nee.tmp_controlside[, ll] * 12 / 1000000 * 1800 * 48
  daily_nee.tmp_controlside[is.na(daily_nee.tmp_controlside[, ll]), ll] <- 0
  
  # calculate cumulative sum, hard-coded with first/second years
  daily_nee.tmp_controlside[1:365, ll] <-
    cumsum(daily_nee.tmp_controlside[1:365, ll])
  daily_nee.tmp_controlside[366:nrow(daily_nee.tmp_controlside), ll] <-
    cumsum(daily_nee.tmp_controlside[366:nrow(daily_nee.tmp_controlside), ll])
  
  # set break (missing value) between two years
  daily_nee.tmp_controlside[366, ll] <- NA
}

## begin plot   
png(
  paste0(out.path, "NEE_control_Daily_growing_post_compost_concord",
    all_data$all_post_data$TIMESTAMP$year[1] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[1] + 1, "_",
    all_data$all_post_data$TIMESTAMP$year[nrow(all_data$all_post_data)] + 1900, "_",
    all_data$all_post_data$TIMESTAMP$yday[nrow(all_data$all_post_data)] + 1, "_",
    "NEE_",
    Sys.Date(), ".png"
  ),
  width = 5.5,
  height = 6,
  units = "in",
  res = 300,
  pointsize = 11,
  bg = "white"
)
par(oma = c(4, 4.5, 0.5, 0.5),
    mar = c(0, 0, 0.25, 0))

par(fig = c(0, 1, 2 / 3, 1), new = FALSE)
plot(
  all_data[[2]]$TIMESTAMP,
  all_data[[2]]$NEE_filled_control_mean,
  pch = 20,
  cex = 0.7,
  col = col.code6$col[1],
  las = 1,
  ylab = "",
  xlab = "",
  xaxt = "n",
  xaxs = "i",
  #yaxt = "n",
  ylim = c(-15, 15),
  cex.axis = 0.8
)

points(
  all_data[[2]]$TIMESTAMP[all_data[[2]]$treatment == "control_post_compost"],
  all_data[[2]]$NEE[all_data[[2]]$treatment == "control_post_compost"],
  pch = 20,
  cex = 0.7,
  col = col.code6$col[2]
)

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_controlside$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(a)"),
  adj = c(0, 1),
  cex = 0.9,
  
)

mtext(
  side = 2,
  target.plot.var_nee_control_daily.title[[1]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)
legend(
  "topleft",
  fill = col.code6$col,
  border = NA,
  legend = col.code6$col.name,
  ncol = 2,
  cex = 0.7,
  bty = "n"
)

## panel b
par(fig = c(0, 1, 1 / 3, 2 / 3), new = TRUE)
plot(
  daily_nee.tmp_controlside_2$date,
  daily_nee.tmp_controlside_2$daily_gpp,
  xlab = "",
  ylab = "",
  cex = 0,
  col = "forestgreen",
  bg = "forestgreen",
  xaxt = "n",
  las = 1,
  pch = 21,
  xaxs = "i",
  ylim = c(-10, 10),
  cex.axis = 0.8
)
polygon(c(daily_nee.tmp_controlside_2$date,
          rev(daily_nee.tmp_controlside_2$date)),
        c(daily_nee.tmp_controlside_2$daily_reco975 ,
          rev(daily_nee.tmp_controlside_2$daily_reco025)),
        col = col.code5$col3[1],
        border = NA)
polygon(c(daily_nee.tmp_controlside_2$date,
          rev(daily_nee.tmp_controlside_2$date)),
        c(daily_nee.tmp_controlside_2$daily_gppq975 ,
          rev(daily_nee.tmp_controlside_2$daily_gpp_q025)),
        col = col.code5$col3[2],
        border = NA)
points(
  daily_nee.tmp_controlside_2$date,
  daily_nee.tmp_controlside_2$daily_reco,
  cex = 0.6,
  col = "red",
  bg = "red",
  pch = 21,
)

points(
  daily_nee.tmp_controlside_2$date,
  daily_nee.tmp_controlside_2$daily_gpp,
  cex = 0.6,
  col = "forestgreen",
  bg = "forestgreen",
  pch = 21,
)


abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_controlside$date[366], lwd= 1.5, col = "black")

text(
  x = all_data$all_post_data$time.id[1],
  y = 30,
  paste0("(b)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee_control_daily.title[[2]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)


## panel c
par(fig = c(0, 1, 0, 1 / 3), new = TRUE)
plot(
  daily_nee.tmp_controlside$date,
  daily_nee.tmp_controlside$daily_nee,
  type = "l",
  lwd = 1.5,
  col = "black",
  xlab = "",
  ylab = "",
  xaxt = "n",
  las = 1,
  xaxs = "i",
  ylim = c(-600, 800),
  cex.axis = 0.8
)

lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_gpp,
      lwd = 1.5,
      col = "forestgreen",
      lty = 1
      )

lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_reco,
      lwd = 1.5,
      col = "red",
      lty = 1
      )

lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_gpp_q025 ,
      lwd = 1,
      col = "forestgreen",
      lty = 3
      )

lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_gppq975  ,
      lwd = 1,
      col = "forestgreen",
      lty = 3
      )

lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_reco025,
      lwd = 1,
      col = "red",
      lty = 3
      )
lines(daily_nee.tmp_controlside$date,
      daily_nee.tmp_controlside$daily_reco975,
      lwd = 1,
      col = "red",
      lty = 3
      )

abline(
  v = 2020 + 290 / 366,
  col = "red",
  lwd = 2,
  lty = 4
)
abline(h = 0, col = "black")
abline(v = daily_nee.tmp_controlside$date[366], lwd= 1.5, col = "black")

axis(
  side = 1,
  at = all_data$all_post_data$time.id[month.loc],
  labels = month.ticks,
  tck = -.025,
  cex.axis = 0.8
)

text(
  x = all_data$all_post_data$time.id[1],
  y = 1200,
  paste0("(c)"),
  adj = c(0, 1),
  cex = 0.9
)

mtext(
  side = 2,
  target.plot.var_nee_control_daily.title[[3]],
  line = 3,
  outer = FALSE,
  cex = 0.8
)

axis(
  side = 1,
  at = c(2019.75, 2020.92, 2021.17),
  label = c(2019, 2020, 2021),
  cex.axis = 0.8,
  tck = -.025,
  lty = 0,
  bty = "n",
  line = 0.9
)

mtext(
  side = 1,
  "Month / Year",
  line = 3,
  outer = FALSE,
  cex = 0.8
)


dev.off()
```

#Cumlative sum Reco control side pre compost application with CI's

```{r}
cumsum(tapply(all_data$all_pre_data$RECO_predict_control_mean,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$RECO_predict_control_q025,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$RECO_predict_control_q975 ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

```
#Cumlative sum GPP control side pre compost application with CI's

```{r}
cumsum(tapply(all_data$all_pre_data$GPP_control_mean ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$GPP_control_q025,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$GPP_control_q975 ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```


#Cumlative sum Reco control side post compost application with CI's
```{r}

#Reco Cumsum
cumsum(tapply(all_data$all_post_data$RECO_predict_control_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#lower bound CI
cumsum(tapply(all_data$all_post_data$RECO_predict_control_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#upper bound CI
cumsum(tapply(all_data$all_post_data$RECO_predict_control_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```
#Cumulative sum GPP control side post compost application with CI's

```{r}

#GPP Cumsum
cumsum(tapply(all_data$all_post_data$GPP_control_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#comparison of GPP cum sum using reco predict

#making the comparison variable
all_data$all_post_data$GPP_control_with_pred_Reco <- (all_data$all_post_data$NEE_filled_control_mean - all_data$all_post_data$RECO_predict_control_mean)


#cumsum the comparison variable
cumsum(tapply(all_data$all_post_data$GPP_control_with_pred_Reco,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
######################################################################
#lower bound CI
cumsum(tapply(all_data$all_post_data$GPP_control_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


######################################################################


#upper bound CI
cumsum(tapply(all_data$all_post_data$GPP_control_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```




#Cumlative sum Reco Treatment side pre compost application with CI's

```{r}
cumsum(tapply(all_data$all_pre_data$RECO_predict_treatment_mean,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48



cumsum(tapply(all_data$all_pre_data$RECO_predict_treatment_q025,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$RECO_predict_treatment_q975 ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

```

#Cumlative sum GPP treatment side pre compost application with CI's

```{r}
cumsum(tapply(all_data$all_pre_data$GPP_treatment_mean ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$GPP_treatment_q025,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


cumsum(tapply(all_data$all_pre_data$GPP_treatment_q975 ,
            round(all_data$all_pre_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```


#Cumlative sum Reco Treatment side post compost application with CI's
```{r}

#Reco Cumsum
cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48



#lower bound CI
cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#upper bound CI
cumsum(tapply(all_data$all_post_data$RECO_predict_treatment_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```
#Cumulative sum GPP treament side post compost application with CI's

```{r}

#GPP Cumsum
cumsum(tapply(all_data$all_post_data$GPP_treatment_mean,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48


########GPP comparison using Reco_predict######

#making the comparison GPP variable
all_data$all_post_data$GPP_treatment_with_pred_Reco <- (all_data$all_post_data$NEE_filled_treatment_mean - all_data$all_post_data$RECO_predict_treatment_mean)

all_data$all_post_data$GPP_treatment_with_pred_Reco [(all_data$all_post_data$Rg <= 10 )]<-0


cumsum(tapply(all_data$all_post_data$GPP_treatment_with_pred_Reco,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#essentially the same. -387.73 with this v.s -387.66

#lower bound CI
cumsum(tapply(all_data$all_post_data$GPP_treatment_q025,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48

#upper bound CI
cumsum(tapply(all_data$all_post_data$GPP_treatment_q975 ,
            round(all_data$all_post_data$Doy_water ),
            function(x) mean(x,na.rm=T)))*12/1000000*1800*48
```


```{r}
all_data$all_pre_data
write.csv(
  all_data$all_pre_data,
  paste0(out.path, Sys.Date(), "_all_pre_compost_data.csv"),
  quote = T,
  row.names = F
)

all_data$all_post_data
write.csv(
  all_data$all_pre_data,
  paste0(out.path, Sys.Date(), "_all_post_compost_data.csv"),
  quote = T,
  row.names = F
)
```


